<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retrive a secret</title>
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css?family=abeezee:400" rel="stylesheet" />
    <link rel="stylesheet" href="css/retrive.css">
    <script src="./lib/decrypt.js"></script>

    <!-- Make sure to not cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
</head>

<body>
    <a href="/" class="header">
        Secret Sharer
    </a>

    <div class="container">
        <label for="accessid">Access ID:</label><br />
        <input type="text" maxlength="6" class="input" id="accessid" placeholder="------" style="margin-bottom:20px;">

        <label for="password">Password:</label><br />
        <input class="input" type="password" id="password" placeholder="my-super-secret-password">

        <button class="btn retrive" style="margin-top:10px;">Retrive</button>

        <div class="decrypted">
            <label for="decrypted-content">Decrypted Content:</label><br />
            <textarea class="input content" id="decrypted-content" disabled></textarea>
            <button type="button" class="btn copy-btn">Copy</button>
        </div>
    </div>
</body>

<script>
    // Private function
    (() => {
        const accessID_input = document.querySelector('#accessid');
        const password = document.querySelector('#password');
        const decryptedSection = document.querySelector('.decrypted');
        const decryptedContent = document.querySelector('#decrypted-content');
        const searchParams = new URLSearchParams(window.location.search);
        let encryptedString = null

        document.querySelector('.copy-btn').addEventListener('click', () => {
            const decryptedContent = document.querySelector('#decrypted-content');
            navigator.clipboard.writeText(decryptedContent.value);
            alert('Copied to clipboard!');
        });

        if (searchParams.has('access_id')) {
            accessID_input.value = searchParams.get('access_id');
        }

        document.querySelector('.retrive').addEventListener('click', async () => {
            if (accessID_input.value.trim().length !== 6) {
                alert('Please enter Access ID!');
                return null;
            } else if (password.value.trim() === '') {
                alert('Please enter Password!');
                return null;
            }

            if (!encryptedString) {
                const res = await fetch('/api/retrive', {
                    method: 'POST',
                    body: JSON.stringify({
                        accessID: accessID_input.value
                    })
                });

                const data = await res.json();
                if (data.success === true) {
                    encryptedString = data.encrypted;
                } else {
                    alert(data.error || 'Something went wrong!');
                }
            }


            try {
                const decrypted = await decrypt(encryptedString, password.value)
                decryptedSection.style.display = 'block';
                decryptedContent.value = decrypted;
            } catch (err) {
                if (err.message === 'Wrong password or corrupted data') {
                    alert('Incorrect password / corrupted data!');
                } else {
                    console.error(err);
                    alert('An internal error occured!');
                }
            }
        });
    })();
</script>

</html>